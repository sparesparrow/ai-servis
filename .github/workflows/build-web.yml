name: Build Web Pages

on:
  push:
    paths:
      - 'web/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          cd web
          npm install

      - name: Generate Web Pages
        run: |
          cd web
          node scripts/generatePages.js

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-pages
          path: web/dist/

      - name: Deploy Gonzo to AWS S3
        run: |
          cd deploy/aws

          export AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
          export AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
          export AWS_CLOUDFRONT_KEY_ID=${{ secrets.AWS_CLOUDFRONT_KEY_ID }}
          export AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}
          export AWS_REGION=${{ secrets.AWS_REGION }}

          aws s3 sync ../../web/dist/ s3://ai-servis-web-journalists/
          DISTRIBUTION_ID=$(aws cloudfront create-distribution --distribution-config file://deploy/aws/cloudfront-config.json --query Distribution.Id --output text)
          aws cloudfront wait distribution-deployed --id $DISTRIBUTION_ID
          DISTRIBUTION_DOMAIN=$(aws cloudfront get-distribution --id $DISTRIBUTION_ID --query Distribution.DomainName --output text)
          echo "Distribution ID: $DISTRIBUTION_ID"
          echo "Distribution Domain: $DISTRIBUTION_DOMAIN"

          