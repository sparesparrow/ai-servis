version: "3.8"

name: ai-servis-pi-gateway

networks:
  veh_net:

volumes:
  mosquitto_data:
  clips:
  lpr_models:

services:
  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: mqtt-broker
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./services/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto_data:/mosquitto/data
    networks: [veh_net]

  mdns-advertiser:
    build: ./services/mdns-advertiser
    container_name: mdns-advertiser
    restart: unless-stopped
    environment:
      - SERVICE_NAME=ai-servis-pi
      - SERVICE_TYPE=_mqtt._tcp.local.
      - SERVICE_PORT=1883
      - SERVICE_TXT=path=/
    network_mode: host
    depends_on: [mqtt-broker]

  camera-server:
    image: bluenviron/mediamtx:latest
    container_name: camera-server
    restart: unless-stopped
    ports:
      - "8554:8554/tcp"
    environment:
      - MTX_PROTOCOLS=tcp
    networks: [veh_net]

  lpr-engine:
    image: ghcr.io/ai-servis/lpr-engine:latest
    container_name: lpr-engine
    restart: unless-stopped
    environment:
      - MQTT_URL=tcp://mqtt-broker:1883
      - VIN=${VIN:-TESTVIN}
      - RTSP_URL=${ANPR_RTSP_URL:-rtsp://camera-server:8554/stream}
      - OUT_TOPIC=vehicle/events/${VIN}/anpr
      - PRIVACY_HASH=1
    networks: [veh_net]
    depends_on: [mqtt-broker, camera-server]
    volumes:
      - lpr_models:/models
      - clips:/clips

  health-publisher:
    build: ./services/health-publisher
    container_name: health-publisher
    restart: unless-stopped
    environment:
      - MQTT_URL=tcp://mqtt-broker:1883
      - NODE_ID=pi-gateway-001
    networks: [veh_net]
    depends_on: [mqtt-broker]

  mqtt-bridge:
    build: ./services/mqtt-bridge
    container_name: mqtt-bridge
    restart: unless-stopped
    environment:
      - LOCAL_URL=tcp://mqtt-broker:1883
      - REMOTE_URL=${REMOTE_URL:-}
      - FORWARD_TOPICS=${FORWARD_TOPICS:-vehicle/#,device/#,system/#,security/#,privacy/#}
    networks: [veh_net]
    depends_on: [mqtt-broker]

  web-ui:
    image: nginx:alpine
    container_name: web-ui
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ../../web/site:/usr/share/nginx/html:ro
    networks: [veh_net]
